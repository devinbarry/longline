tests:
  # ============================================================
  # BARE COMMAND BYPASSES - Dangerous flags on allowlisted commands
  # ============================================================

  # --- ln: symbolic link attacks ---
  - id: ln-safe-symlink
    command: "ln -s source.txt link.txt"
    expected:
      decision: allow
  - id: ln-force-overwrite
    command: "ln -sf malicious.sh /usr/local/bin/safe"
    expected:
      decision: ask
    # EXPECTED FAIL: ln -sf can overwrite files/binaries

  # --- tar: extraction attacks ---
  - id: tar-list-safe
    command: "tar -tf archive.tar"
    expected:
      decision: allow
  - id: tar-extract-dangerous
    command: "tar -xf archive.tar"
    expected:
      decision: ask
    # EXPECTED FAIL: tar -xf can overwrite files, path traversal
  - id: tar-extract-overwrite
    command: "tar -xvf archive.tar --overwrite"
    expected:
      decision: ask
    # EXPECTED FAIL: explicit overwrite flag

  # --- unzip: extraction attacks ---
  - id: unzip-list-safe
    command: "unzip -l archive.zip"
    expected:
      decision: allow
  - id: unzip-extract-dangerous
    command: "unzip archive.zip"
    expected:
      decision: ask
    # EXPECTED FAIL: unzip can overwrite files
  - id: unzip-overwrite-force
    command: "unzip -o archive.zip"
    expected:
      decision: ask
    # EXPECTED FAIL: -o forces overwrite without prompting

  # --- sed: in-place modification ---
  - id: sed-stdout-safe
    command: "sed 's/foo/bar/' file.txt"
    expected:
      decision: allow
  - id: sed-inplace-dangerous
    command: "sed -i 's/foo/bar/' file.txt"
    expected:
      decision: ask
    # EXPECTED FAIL: -i modifies files in place
  - id: sed-inplace-backup
    command: "sed -i.bak 's/foo/bar/' file.txt"
    expected:
      decision: ask
    # EXPECTED FAIL: still modifies original

  # --- patch: file modification ---
  - id: patch-dryrun-safe
    command: "patch --dry-run < changes.patch"
    expected:
      decision: allow
  - id: patch-apply-dangerous
    command: "patch < changes.patch"
    expected:
      decision: ask
    # EXPECTED FAIL: patch modifies files
  - id: patch-apply-file
    command: "patch -p1 < changes.patch"
    expected:
      decision: ask
    # EXPECTED FAIL: patch modifies files

  # --- gzip/gunzip: removes original ---
  - id: gzip-keep-safe
    command: "gzip -k file.txt"
    expected:
      decision: allow
  - id: gzip-remove-original
    command: "gzip file.txt"
    expected:
      decision: ask
    # EXPECTED FAIL: gzip removes original by default
  - id: gunzip-keep-safe
    command: "gunzip -k file.txt.gz"
    expected:
      decision: allow
  - id: gunzip-remove-original
    command: "gunzip file.txt.gz"
    expected:
      decision: ask
    # EXPECTED FAIL: gunzip removes original by default

  # --- npx: arbitrary code execution ---
  - id: npx-known-safe
    command: "npx prettier --check ."
    expected:
      decision: allow
  - id: npx-arbitrary-package
    command: "npx some-random-package"
    expected:
      decision: ask
    # EXPECTED FAIL: npx can run arbitrary npm packages
  - id: npx-typosquat-risk
    command: "npx loadash"
    expected:
      decision: ask
    # EXPECTED FAIL: typosquatting risk (lodash vs loadash)

  # --- find: file deletion ---
  - id: find-name-safe
    command: "find . -name '*.rs'"
    expected:
      decision: allow
  - id: find-type-safe
    command: "find . -type f"
    expected:
      decision: allow
  - id: find-delete-dangerous
    command: "find . -delete"
    expected:
      decision: ask
      rule_id: find-delete
  - id: find-exec-rm-dangerous
    command: "find . -exec rm {} \\;"
    expected:
      decision: ask
      rule_id: find-exec-rm

  # --- xargs: command execution ---
  - id: xargs-echo-safe
    command: "xargs echo"
    expected:
      decision: allow
  - id: xargs-cat-safe
    command: "xargs cat"
    expected:
      decision: allow
  - id: xargs-rm-dangerous
    command: "xargs rm"
    expected:
      decision: ask
      rule_id: xargs-rm
  - id: xargs-rm-rf-dangerous
    command: "xargs rm -rf"
    expected:
      decision: ask
      rule_id: xargs-rm

  # --- cp: force overwrite ---
  - id: cp-safe
    command: "cp a.txt b.txt"
    expected:
      decision: allow
  - id: cp-recursive-safe
    command: "cp -r src/ dest/"
    expected:
      decision: allow
  - id: cp-force-dangerous
    command: "cp -f sensitive.txt /tmp/exfil"
    expected:
      decision: ask
    # EXPECTED FAIL: -f forces overwrite without prompting
  - id: cp-force-recursive-dangerous
    command: "cp -rf /important /tmp/backup"
    expected:
      decision: ask
    # EXPECTED FAIL: -rf can overwrite directories

  # --- mv: force overwrite ---
  - id: mv-safe
    command: "mv a.txt b.txt"
    expected:
      decision: allow
  - id: mv-force-dangerous
    command: "mv -f important.txt /dev/null"
    expected:
      decision: ask
    # EXPECTED FAIL: -f forces overwrite without prompting

  # --- tee: write to sensitive locations ---
  - id: tee-safe
    command: "tee output.txt"
    expected:
      decision: allow
  - id: tee-etc-passwd-dangerous
    command: "tee /etc/passwd"
    expected:
      decision: ask
    # EXPECTED FAIL: writing to system file
  - id: tee-etc-shadow-dangerous
    command: "tee /etc/shadow"
    expected:
      decision: ask
    # EXPECTED FAIL: writing to system file
  - id: tee-append-bashrc-dangerous
    command: "tee -a ~/.bashrc"
    expected:
      decision: deny
      rule_id: edit-shell-profile

  # ============================================================
  # GIT COMMAND BYPASSES
  # ============================================================

  # --- git branch: force delete ---
  - id: git-branch-list-safe
    command: "git branch -a"
    expected:
      decision: allow
  - id: git-branch-delete-safe
    command: "git branch -d feature"
    expected:
      decision: allow
    # Safe delete (fails if not merged)
  - id: git-branch-force-delete
    command: "git branch -D feature"
    expected:
      decision: ask
      rule_id: git-branch-delete-force

  # --- git remote: modification ---
  - id: git-remote-list-safe
    command: "git remote -v"
    expected:
      decision: allow
  - id: git-remote-show-safe
    command: "git remote show origin"
    expected:
      decision: allow
  - id: git-remote-add
    command: "git remote add upstream https://github.com/foo/bar"
    expected:
      decision: ask
    # EXPECTED FAIL: modifies remote configuration
  - id: git-remote-remove
    command: "git remote remove origin"
    expected:
      decision: ask
    # EXPECTED FAIL: removes remote
  - id: git-remote-set-url
    command: "git remote set-url origin https://evil.com/repo"
    expected:
      decision: ask
    # EXPECTED FAIL: could redirect to malicious repo

  # --- git tag: deletion ---
  - id: git-tag-list-safe
    command: "git tag -l"
    expected:
      decision: allow
  - id: git-tag-create-safe
    command: "git tag v1.0.0"
    expected:
      decision: allow
  - id: git-tag-delete
    command: "git tag -d v1.0.0"
    expected:
      decision: ask
    # EXPECTED FAIL: deletes tag
  - id: git-tag-delete-remote
    command: "git push origin --delete v1.0.0"
    expected:
      decision: ask
    # EXPECTED FAIL: deletes remote tag

  # --- git config: global modification ---
  - id: git-config-read-safe
    command: "git config user.name"
    expected:
      decision: allow
  - id: git-config-local-safe
    command: "git config user.email foo@bar.com"
    expected:
      decision: allow
    # Local config is relatively safe
  - id: git-config-global-dangerous
    command: "git config --global user.email foo@bar.com"
    expected:
      decision: ask
    # EXPECTED FAIL: modifies global git config
  - id: git-config-system-dangerous
    command: "git config --system core.editor vim"
    expected:
      decision: ask
    # EXPECTED FAIL: modifies system-wide config

  # --- git stash: data loss ---
  - id: git-stash-save-safe
    command: "git stash"
    expected:
      decision: allow
  - id: git-stash-list-safe
    command: "git stash list"
    expected:
      decision: allow
  - id: git-stash-pop-safe
    command: "git stash pop"
    expected:
      decision: allow
  - id: git-stash-drop-dangerous
    command: "git stash drop"
    expected:
      decision: ask
    # EXPECTED FAIL: loses stashed work
  - id: git-stash-drop-specific
    command: "git stash drop stash@{0}"
    expected:
      decision: ask
    # EXPECTED FAIL: loses stashed work
  - id: git-stash-clear-dangerous
    command: "git stash clear"
    expected:
      decision: ask
    # EXPECTED FAIL: loses ALL stashed work

  # --- git reflog: history manipulation ---
  - id: git-reflog-show-safe
    command: "git reflog"
    expected:
      decision: allow
  - id: git-reflog-show-branch-safe
    command: "git reflog show main"
    expected:
      decision: allow
  - id: git-reflog-delete-dangerous
    command: "git reflog delete HEAD@{0}"
    expected:
      decision: ask
    # EXPECTED FAIL: loses reflog history
  - id: git-reflog-expire-dangerous
    command: "git reflog expire --expire=now --all"
    expected:
      decision: ask
    # EXPECTED FAIL: expires all reflog entries

  # --- git gc: aggressive pruning ---
  - id: git-gc-safe
    command: "git gc"
    expected:
      decision: allow
  - id: git-gc-auto-safe
    command: "git gc --auto"
    expected:
      decision: allow
  - id: git-gc-prune-now-dangerous
    command: "git gc --prune=now"
    expected:
      decision: ask
    # EXPECTED FAIL: immediately removes unreachable objects
  - id: git-gc-aggressive-dangerous
    command: "git gc --aggressive --prune=now"
    expected:
      decision: ask
    # EXPECTED FAIL: aggressive pruning can lose data

  # --- git worktree: removal ---
  - id: git-worktree-list-safe
    command: "git worktree list"
    expected:
      decision: allow
  - id: git-worktree-add-safe
    command: "git worktree add ../feature feature-branch"
    expected:
      decision: allow
  - id: git-worktree-remove-dangerous
    command: "git worktree remove ../feature"
    expected:
      decision: ask
    # EXPECTED FAIL: removes worktree directory
  - id: git-worktree-prune-dangerous
    command: "git worktree prune"
    expected:
      decision: ask
    # EXPECTED FAIL: removes stale worktree info

  # --- git bisect: state modification ---
  - id: git-bisect-start-safe
    command: "git bisect start"
    expected:
      decision: allow
  - id: git-bisect-good-safe
    command: "git bisect good"
    expected:
      decision: allow
  - id: git-bisect-reset-dangerous
    command: "git bisect reset"
    expected:
      decision: ask
    # EXPECTED FAIL: exits bisect, changes HEAD

  # --- git pull: force ---
  - id: git-pull-safe
    command: "git pull"
    expected:
      decision: allow
  - id: git-pull-rebase-safe
    command: "git pull --rebase"
    expected:
      decision: allow
  - id: git-pull-force-dangerous
    command: "git pull --force"
    expected:
      decision: ask
    # EXPECTED FAIL: can overwrite local changes

  # --- git rebase: abort/skip ---
  - id: git-rebase-safe
    command: "git rebase main"
    expected:
      decision: allow
  - id: git-rebase-abort-dangerous
    command: "git rebase --abort"
    expected:
      decision: ask
    # EXPECTED FAIL: discards rebase progress
  - id: git-rebase-skip-dangerous
    command: "git rebase --skip"
    expected:
      decision: ask
    # EXPECTED FAIL: skips commit, can lose changes

  # ============================================================
  # PACKAGE MANAGER BYPASSES
  # ============================================================

  # --- npm run: arbitrary script execution ---
  - id: npm-run-test-safe
    command: "npm run test"
    expected:
      decision: allow
  - id: npm-run-build-safe
    command: "npm run build"
    expected:
      decision: allow
  - id: npm-run-arbitrary-dangerous
    command: "npm run evil-script"
    expected:
      decision: ask
    # EXPECTED FAIL: npm run can execute arbitrary scripts from package.json

  # --- npm start: inherent code execution risk ---
  - id: npm-start-dangerous
    command: "npm start"
    expected:
      decision: ask
    # EXPECTED FAIL: npm start runs scripts defined in package.json

  # --- npm audit: fix modifies packages ---
  - id: npm-audit-safe
    command: "npm audit"
    expected:
      decision: allow
  - id: npm-audit-fix-dangerous
    command: "npm audit fix"
    expected:
      decision: ask
    # EXPECTED FAIL: modifies package.json and node_modules
  - id: npm-audit-fix-force
    command: "npm audit fix --force"
    expected:
      decision: ask
    # EXPECTED FAIL: forces potentially breaking changes

  # --- npm exec: arbitrary code ---
  - id: npm-exec-dangerous
    command: "npm exec -- some-package"
    expected:
      decision: ask
    # EXPECTED FAIL: runs arbitrary package code

  # --- npm uninstall: removes packages ---
  - id: npm-uninstall-dangerous
    command: "npm uninstall lodash"
    expected:
      decision: ask
    # EXPECTED FAIL: modifies project dependencies

  # --- pip install: can install malicious packages ---
  - id: pip-install-known-safe
    command: "pip install requests"
    expected:
      decision: allow
  - id: pip-install-arbitrary-dangerous
    command: "pip install evil-malicious-pkg"
    expected:
      decision: ask
    # EXPECTED FAIL: pip install can fetch and run arbitrary code
  - id: pip3-install-arbitrary-dangerous
    command: "pip3 install typosquatted-package"
    expected:
      decision: ask
    # EXPECTED FAIL: typosquatting risk

  # --- pip uninstall: removes packages ---
  - id: pip-uninstall-dangerous
    command: "pip uninstall requests"
    expected:
      decision: ask
    # EXPECTED FAIL: removes installed package
  - id: pip3-uninstall-dangerous
    command: "pip3 uninstall -y requests"
    expected:
      decision: ask
    # EXPECTED FAIL: removes without confirmation

  # --- gem install: can install malicious gems ---
  - id: gem-install-known-safe
    command: "gem install rails"
    expected:
      decision: allow
  - id: gem-install-arbitrary-dangerous
    command: "gem install evil-malicious-gem"
    expected:
      decision: ask
    # EXPECTED FAIL: gem install can fetch and run arbitrary code

  # --- gem uninstall: removes packages ---
  - id: gem-uninstall-dangerous
    command: "gem uninstall rails"
    expected:
      decision: ask
    # EXPECTED FAIL: removes installed gem

  # --- cargo run: inherent code execution risk ---
  - id: cargo-run-safe
    command: "cargo run"
    expected:
      decision: allow
  - id: cargo-run-release-safe
    command: "cargo run --release"
    expected:
      decision: allow
    # Note: cargo run is in allowlist, but executes arbitrary code from Cargo.toml

  # --- cargo publish: publishes to crates.io ---
  - id: cargo-publish-dangerous
    command: "cargo publish"
    expected:
      decision: ask
    # EXPECTED FAIL: publishes to public registry

  # --- npm publish: publishes to npm ---
  - id: npm-publish-dangerous
    command: "npm publish"
    expected:
      decision: ask
    # EXPECTED FAIL: publishes to public registry

  # --- gem push: publishes to rubygems ---
  - id: gem-push-dangerous
    command: "gem push pkg.gem"
    expected:
      decision: ask
    # EXPECTED FAIL: publishes to public registry

  # --- twine/pip upload: publishes to PyPI ---
  - id: twine-upload-dangerous
    command: "twine upload dist/*"
    expected:
      decision: ask
    # EXPECTED FAIL: publishes to public registry
  - id: pip-upload-dangerous
    command: "pip upload dist/*"
    expected:
      decision: ask
    # Note: pip upload is not a real command but tests the pattern

  # ============================================================
  # SPECIAL CASES - git symbolic-ref (the original issue)
  # ============================================================

  - id: git-symbolic-ref-read-safe
    command: "git symbolic-ref HEAD"
    expected:
      decision: ask
    # Currently asks because removed from allowlist
  - id: git-symbolic-ref-delete-dangerous
    command: "git symbolic-ref --delete HEAD"
    expected:
      decision: ask
    # Must always ask - destructive operation
  - id: git-symbolic-ref-short-safe
    command: "git symbolic-ref --short HEAD"
    expected:
      decision: ask
    # Currently asks because removed from allowlist
