version: 1
default_decision: ask
safety_level: high

allowlists:
  commands:
    # ── Always safe: read-only / output-only ──────────────────────
    - ls
    - echo
    - pwd
    - whoami
    - date
    - cat
    - head
    - tail
    - wc
    - file
    - which
    - type
    - basename
    - dirname
    - realpath
    - readlink
    - stat
    - du
    - printf
    - md5sum
    - sha256sum
    - sha1sum
    - cksum
    - "true"
    - "false"
    - grep
    - rg
    - find
    - xargs
    - fd
    - sort
    - uniq
    - tr
    - cut
    - diff
    - jq
    - yq
    - test
    # ── Always safe: dev tools (no publish risk) ──────────────────
    - make
    - cmake
    - rustc
    - java
    - javac
    - npx
    # ── Interpreters: safe invocations only ─────────────────────
    - "python --version"
    - "python -V"
    - "python3 --version"
    - "python3 -V"
    - "python -m json.tool"
    - "python3 -m json.tool"
    - "python -m py_compile"
    - "python3 -m py_compile"
    - "python -m compileall"
    - "python3 -m compileall"
    - "node --version"
    - "node -v"
    - "ruby --version"
    - "ruby -v"
    # ── uv: safe tool invocations ───────────────────────────────
    - "uv run pytest"
    - "uv run mypy"
    - "uv run ruff"
    - "uv run black"
    - "uv run isort"
    - "uv run flake8"
    - "uv run pylint"
    - "uv run pyright"
    - "uv run bandit"
    - "uv run coverage"
    # ── Always safe: filesystem ops (secrets caught by rules) ─────
    - mkdir
    - touch
    - ln
    - cp
    - mv
    - tee
    - tar
    - gzip
    - gunzip
    - zip
    - unzip
    # ── Always safe: text processing ──────────────────────────────
    - sed
    - awk
    - patch
    # ── Git: read operations ──────────────────────────────────────
    - "git status"
    - "git diff"
    - "git log"
    - "git show"
    - "git branch"
    - "git stash list"
    - "git remote"
    - "git tag"
    - "git rev-parse"
    - "git config"
    # ── Git: safe write operations ────────────────────────────────
    - "git add"
    - "git commit"
    - "git fetch"
    - "git pull"
    - "git push"
    - "git stash"
    - "git checkout"
    - "git switch"
    - "git restore"
    - "git merge"
    - "git rebase"
    - "git cherry-pick"
    - "git worktree"
    - "git clone"
    - "git init"
    # ── Git: read-only extras ─────────────────────────────────────
    - "git blame"
    - "git bisect"
    - "git describe"
    - "git shortlog"
    - "git reflog"
    - "git ls-files"
    - "git ls-tree"
    - "git cat-file"
    # ── Git: info/help commands ───────────────────────────────────
    - "git --version"
    - "git -v"
    - "git help"
    - "git -h"
    # ── Git: maintenance/inspection commands ──────────────────────
    - "git gc"
    - "git fsck"
    - "git verify-pack"
    # ── Git: history/ref commands ─────────────────────────────────
    - "git merge-base"
    - "git rev-list"
    - "git for-each-ref"
    - "git name-rev"
    # ── Cargo: safe invocations ───────────────────────────────────
    - "cargo build"
    - "cargo test"
    - "cargo check"
    - "cargo clippy"
    - "cargo fmt"
    - "cargo run"
    - "cargo bench"
    - "cargo doc"
    - "cargo clean"
    - "cargo update"
    - "cargo add"
    - "cargo remove"
    - "cargo init"
    - "cargo new"
    - "cargo tree"
    - "cargo metadata"
    - "cargo vendor"
    # ── npm: safe invocations ─────────────────────────────────────
    - "npm install"
    - "npm ci"
    - "npm test"
    - "npm run"
    - "npm start"
    - "npm ls"
    - "npm outdated"
    - "npm audit"
    - "npm init"
    - "npm exec"
    - "npm info"
    - "npm pack"
    # ── pip/pip3: safe invocations ────────────────────────────────
    - "pip install"
    - "pip list"
    - "pip show"
    - "pip freeze"
    - "pip check"
    - "pip3 install"
    - "pip3 list"
    - "pip3 show"
    - "pip3 freeze"
    - "pip3 check"
    # ── gem: safe invocations ─────────────────────────────────────
    - "gem install"
    - "gem list"
    - "gem info"
    - "gem search"
    # ── go: safe invocations ──────────────────────────────────────
    - "go build"
    - "go test"
    - "go run"
    - "go vet"
    - "go fmt"
    - "go mod"
    - "go generate"
    - "go doc"
    - "go get"
    - "go clean"
    - "go env"
    - "go version"
    - "go work"

rules:
  # ============================================================
  # CRITICAL: Filesystem destruction
  # ============================================================
  - id: rm-recursive-root
    level: critical
    match:
      command: rm
      flags:
        any_of: ["-r", "-R", "--recursive", "-rf", "-fr", "-Rf", "-fR"]
      args:
        any_of: ["/", "/*"]
    decision: deny
    reason: "Recursive delete targeting root filesystem"

  - id: rm-recursive-system
    level: critical
    match:
      command: rm
      flags:
        any_of: ["-r", "-R", "--recursive", "-rf", "-fr", "-Rf", "-fR"]
      args:
        any_of: ["/etc", "/etc/*", "/usr", "/usr/*", "/var", "/var/*", "/bin",
                  "/bin/*", "/sbin", "/sbin/*", "/lib", "/lib/*", "/boot",
                  "/boot/*", "/sys", "/sys/*", "/proc", "/proc/*"]
    decision: deny
    reason: "Recursive delete targeting system directory"

  - id: rm-recursive-home
    level: critical
    match:
      command: rm
      flags:
        any_of: ["-r", "-R", "--recursive", "-rf", "-fr", "-Rf", "-fR"]
      args:
        any_of: ["~", "~/", "$HOME", "$HOME/"]
    decision: deny
    reason: "Recursive delete targeting home directory"

  - id: dd-disk-device
    level: critical
    match:
      command: dd
      args:
        any_of: ["of=/dev/sd*", "of=/dev/nvme*", "of=/dev/hd*",
                  "of=/dev/vd*", "of=/dev/xvd*", "of=/dev/disk*"]
    decision: deny
    reason: "dd writing directly to disk device"

  - id: mkfs-any
    level: critical
    match:
      command:
        any_of: [mkfs, "mkfs.ext4", "mkfs.xfs", "mkfs.btrfs", "mkfs.vfat", "mkfs.ntfs"]
    decision: deny
    reason: "Formatting a filesystem"

  - id: fork-bomb
    level: critical
    match:
      command: ":"
    decision: ask
    reason: "Potential fork bomb pattern"

  # ============================================================
  # CRITICAL: Shell injection / remote code execution
  # ============================================================
  - id: curl-pipe-shell
    level: critical
    match:
      pipeline:
        stages:
          - command:
              any_of: [curl, wget]
          - command:
              any_of: [sh, bash, zsh, dash, ksh, fish]
    decision: deny
    reason: "Remote code execution: piping download to shell"

  - id: wget-pipe-interpreter
    level: critical
    match:
      pipeline:
        stages:
          - command:
              any_of: [curl, wget]
          - command:
              any_of: [python, python3, ruby, perl, node]
    decision: deny
    reason: "Remote code execution: piping download to interpreter"

  # ============================================================
  # CRITICAL: Secrets exposure
  # ============================================================
  - id: cat-env-file
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "**/.env.production"]
    decision: deny
    reason: "Reading sensitive environment file"

  - id: cat-ssh-key
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: ["~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "id_rsa", "id_ed25519", "id_ecdsa"]
    decision: deny
    reason: "Reading SSH private key"

  - id: cat-aws-creds
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: ["~/.aws/credentials", "~/.aws/config"]
    decision: deny
    reason: "Reading AWS credentials"

  - id: cat-kube-config
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: ["~/.kube/config"]
    decision: deny
    reason: "Reading Kubernetes config"

  - id: cp-secrets
    level: critical
    match:
      command: cp
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "id_rsa", "id_ed25519", "id_ecdsa",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: ask
    reason: "Copying sensitive file"

  - id: mv-secrets
    level: critical
    match:
      command: mv
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "id_rsa", "id_ed25519", "id_ecdsa",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: ask
    reason: "Moving sensitive file"

  - id: tee-secrets
    level: critical
    match:
      command: tee
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: deny
    reason: "Writing to sensitive file via tee"

  - id: rm-secrets
    level: critical
    match:
      command: rm
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "~/.ssh/authorized_keys",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: ask
    reason: "Deleting sensitive file"

  # ============================================================
  # HIGH: VCS destructive operations
  # ============================================================
  - id: git-force-push-main
    level: high
    match:
      command: git
      flags:
        any_of: ["--force", "-f"]
      args:
        any_of: ["main", "master"]
    decision: deny
    reason: "Force pushing to main/master branch"

  - id: git-reset-hard
    level: high
    match:
      command: git
      args:
        any_of: ["--hard"]
    decision: ask
    reason: "git reset --hard discards uncommitted changes"

  - id: git-clean-force
    level: high
    match:
      command: git
      args:
        any_of: ["clean"]
      flags:
        any_of: ["-f", "--force", "-fd", "-fx", "-fxd"]
    decision: ask
    reason: "git clean -f permanently removes untracked files"

  - id: git-branch-delete-force
    level: high
    match:
      command: git
      args:
        any_of: ["branch"]
      flags:
        any_of: ["-D"]
    decision: ask
    reason: "Force deleting a git branch"

  - id: git-commit-amend
    level: high
    match:
      command: git
      args:
        any_of: ["commit"]
      flags:
        any_of: ["--amend"]
    decision: ask
    reason: "git commit --amend rewrites the previous commit"

  - id: git-remote-modify
    level: high
    match:
      command: git
      args:
        any_of: ["remote"]
      flags:
        any_of: ["add", "remove", "rm", "set-url", "rename"]
    decision: ask
    reason: "Modifying git remote configuration"

  - id: git-tag-delete
    level: high
    match:
      command: git
      args:
        any_of: ["tag"]
      flags:
        any_of: ["-d", "--delete"]
    decision: ask
    reason: "Deleting git tag"

  - id: git-push-delete
    level: high
    match:
      command: git
      args:
        any_of: ["push"]
      flags:
        any_of: ["--delete", "-d"]
    decision: ask
    reason: "Deleting remote branch or tag"

  - id: git-config-global
    level: high
    match:
      command: git
      args:
        any_of: ["config"]
      flags:
        any_of: ["--global", "--system"]
    decision: ask
    reason: "Modifying global/system git configuration"

  - id: git-stash-drop
    level: high
    match:
      command: git
      args:
        any_of: ["stash"]
      flags:
        any_of: ["drop", "clear"]
    decision: ask
    reason: "Dropping stashed changes (data loss)"

  - id: git-reflog-delete
    level: high
    match:
      command: git
      args:
        any_of: ["reflog"]
      flags:
        any_of: ["delete", "expire"]
    decision: ask
    reason: "Deleting reflog entries (history loss)"

  - id: git-gc-prune
    level: high
    match:
      command: git
      args:
        any_of: ["gc"]
      flags:
        starts_with: ["--prune"]
    decision: ask
    reason: "git gc with pruning can remove unreachable objects"

  - id: git-worktree-remove
    level: high
    match:
      command: git
      args:
        any_of: ["worktree"]
      flags:
        any_of: ["remove", "prune"]
    decision: ask
    reason: "Removing git worktree"

  - id: git-bisect-reset
    level: high
    match:
      command: git
      args:
        any_of: ["bisect"]
      flags:
        any_of: ["reset"]
    decision: ask
    reason: "Exiting bisect mode (changes HEAD)"

  - id: git-pull-force
    level: high
    match:
      command: git
      args:
        any_of: ["pull"]
      flags:
        any_of: ["--force", "-f"]
    decision: ask
    reason: "git pull --force can overwrite local changes"

  - id: git-rebase-abort
    level: high
    match:
      command: git
      args:
        any_of: ["rebase"]
      flags:
        any_of: ["--abort", "--skip"]
    decision: ask
    reason: "Aborting or skipping rebase (may lose changes)"

  # ============================================================
  # HIGH: Exfiltration
  # ============================================================
  - id: curl-upload-secrets
    level: high
    match:
      command: curl
      flags:
        any_of: ["-d", "--data", "-F", "--form", "--data-binary", "--data-urlencode", "-T", "--upload-file"]
    decision: ask
    reason: "curl with data upload flags"

  - id: scp-upload
    level: high
    match:
      command: scp
    decision: ask
    reason: "scp file transfer"

  - id: rsync-remote
    level: high
    match:
      command: rsync
    decision: ask
    reason: "rsync file transfer"

  - id: nc-netcat
    level: high
    match:
      command:
        any_of: [nc, netcat, ncat]
    decision: ask
    reason: "Netcat network connection"

  # ============================================================
  # HIGH: Secrets via environment
  # ============================================================
  - id: printenv
    level: high
    match:
      command:
        any_of: [printenv, env]
    decision: ask
    reason: "Environment dump may expose secrets"

  - id: source-env
    level: high
    match:
      command:
        any_of: [source, "."]
      args:
        any_of: [".env", ".env.*", "**/.env", "**/.env.*", ".envrc"]
    decision: deny
    reason: "Sourcing environment file"

  # ============================================================
  # HIGH: Network / process operations
  # ============================================================
  - id: kill-signal
    level: high
    match:
      command:
        any_of: [kill, killall, pkill]
      flags:
        any_of: ["-9", "-KILL", "-SIGKILL"]
    decision: ask
    reason: "Forceful process termination"

  - id: iptables-modify
    level: high
    match:
      command:
        any_of: [iptables, ip6tables, nft, ufw]
    decision: ask
    reason: "Firewall rule modification"

  # ============================================================
  # HIGH: System config modification
  # ============================================================
  - id: chmod-777
    level: high
    match:
      command: chmod
      args:
        any_of: ["777"]
    decision: ask
    reason: "Setting world-writable permissions"

  - id: edit-etc-hosts
    level: high
    match:
      command:
        any_of: [tee, ">>"]
      args:
        any_of: ["/etc/hosts"]
    decision: deny
    reason: "Modifying /etc/hosts"

  - id: edit-sudoers
    level: high
    match:
      command:
        any_of: [visudo, tee]
      args:
        any_of: ["/etc/sudoers", "/etc/sudoers.d/*"]
    decision: deny
    reason: "Modifying sudoers configuration"

  - id: crontab-modify
    level: high
    match:
      command: crontab
      flags:
        any_of: ["-e", "-r"]
    decision: ask
    reason: "Modifying system crontab"

  - id: systemctl-modify
    level: high
    match:
      command:
        any_of: [systemctl, launchctl]
      args:
        any_of: ["stop", "disable", "mask", "enable", "start", "restart"]
    decision: ask
    reason: "Modifying system service"

  - id: edit-shell-profile
    level: high
    match:
      command:
        any_of: [tee]
      args:
        any_of: ["~/.bashrc", "~/.zshrc", "~/.bash_profile", "~/.profile",
                  "~/.zprofile", "/etc/profile", "/etc/bash.bashrc"]
    decision: deny
    reason: "Modifying shell profile"

  # ============================================================
  # HIGH: Docker destructive
  # ============================================================
  - id: docker-volume-rm
    level: high
    match:
      command: docker
      args:
        any_of: ["volume"]
      flags:
        any_of: ["rm", "prune"]
    decision: ask
    reason: "Docker volume removal"

  - id: docker-system-prune
    level: high
    match:
      command: docker
      args:
        any_of: ["system"]
      flags:
        any_of: ["prune"]
    decision: ask
    reason: "Docker system prune"

  # ============================================================
  # HIGH: Disk / partition
  # ============================================================
  - id: fdisk
    level: high
    match:
      command:
        any_of: [fdisk, gdisk, parted, partprobe]
    decision: deny
    reason: "Disk partitioning tool"

  - id: mount-unmount
    level: high
    match:
      command:
        any_of: [mount, umount]
    decision: ask
    reason: "Filesystem mount/unmount"

  # ============================================================
  # HIGH: Destructive find/xargs patterns
  # ============================================================
  - id: find-delete
    level: high
    match:
      command: find
      flags:
        any_of: ["-delete"]
    decision: ask
    reason: "find -delete recursively removes matching files"

  - id: find-exec-rm
    level: high
    match:
      command: find
      args:
        any_of: ["-exec"]
      flags:
        any_of: ["rm"]
    decision: ask
    reason: "find -exec with rm can delete files"

  - id: xargs-rm
    level: high
    match:
      command: xargs
      args:
        any_of: ["rm"]
    decision: ask
    reason: "xargs executing rm on piped input"

  # ============================================================
  # HIGH: Filesystem destructive operations (allowlist bypass)
  # ============================================================
  - id: ln-force
    level: high
    match:
      command: ln
      flags:
        any_of: ["-f", "--force", "-sf", "-fs", "-fn", "-nf"]
    decision: ask
    reason: "ln -f can overwrite existing files"

  - id: cp-force
    level: high
    match:
      command: cp
      flags:
        any_of: ["-f", "--force", "-rf", "-fr"]
    decision: ask
    reason: "cp -f overwrites without prompting"

  - id: mv-force
    level: high
    match:
      command: mv
      flags:
        any_of: ["-f", "--force"]
    decision: ask
    reason: "mv -f overwrites without prompting"

  - id: tar-extract
    level: high
    match:
      command: tar
      flags:
        starts_with: ["-x", "--extract"]
    decision: ask
    reason: "tar extraction can overwrite files"

  - id: unzip-extract
    level: high
    match:
      command: unzip
      flags:
        none_of: ["-l", "-t", "-Z", "-v"]
    decision: ask
    reason: "unzip extraction can overwrite files"

  - id: sed-inplace
    level: high
    match:
      command: sed
      flags:
        starts_with: ["-i", "--in-place"]
    decision: ask
    reason: "sed -i modifies files in place"

  - id: patch-apply
    level: high
    match:
      command: patch
      flags:
        none_of: ["--dry-run", "-C", "--check"]
    decision: ask
    reason: "patch modifies files"

  - id: gzip-no-keep
    level: high
    match:
      command: gzip
      flags:
        none_of: ["-k", "--keep", "-c", "--stdout", "-t", "--test", "-l", "--list"]
    decision: ask
    reason: "gzip removes original file by default"

  - id: gunzip-no-keep
    level: high
    match:
      command: gunzip
      flags:
        none_of: ["-k", "--keep", "-c", "--stdout", "-t", "--test", "-l", "--list"]
    decision: ask
    reason: "gunzip removes original file by default"

  - id: tee-system-files
    level: high
    match:
      command: tee
      args:
        any_of: ["/etc/*", "/usr/*", "/var/*", "/bin/*", "/sbin/*", "/lib/*"]
    decision: ask
    reason: "Writing to system directory"

  # ============================================================
  # HIGH: Package manager operations
  # ============================================================
  - id: pip-install
    level: high
    match:
      command:
        any_of: [pip, pip3]
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Python packages"

  - id: npm-install
    level: high
    match:
      command: npm
      args:
        any_of: ["install", "i", "ci"]
    decision: ask
    reason: "Installing npm packages"

  - id: gem-install
    level: high
    match:
      command: gem
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Ruby gems"

  - id: npm-audit-fix
    level: high
    match:
      command: npm
      args:
        any_of: ["audit"]
      flags:
        any_of: ["fix"]
    decision: ask
    reason: "npm audit fix modifies package dependencies"

  - id: npm-exec
    level: high
    match:
      command: npm
      args:
        any_of: ["exec"]
    decision: ask
    reason: "npm exec runs arbitrary package code"

  - id: npx-run
    level: high
    match:
      command: npx
    decision: ask
    reason: "npx can execute arbitrary npm packages"

  # ============================================================
  # STRICT: Cautionary
  # ============================================================
  - id: git-force-push-any
    level: strict
    match:
      command: git
      flags:
        any_of: ["--force", "-f"]
      args:
        any_of: ["push"]
    decision: ask
    reason: "Force pushing (any branch)"

  - id: git-checkout-dot
    level: strict
    match:
      command: git
      args:
        any_of: ["checkout", "restore"]
      flags:
        any_of: [".", "--"]
    decision: ask
    reason: "Discarding all local changes"

  - id: sudo-rm
    level: strict
    match:
      command: sudo
      args:
        any_of: ["rm"]
    decision: ask
    reason: "Running rm with elevated privileges"

  - id: crontab-remove
    level: strict
    match:
      command: crontab
      flags:
        any_of: ["-r"]
    decision: deny
    reason: "Removing all cron jobs"
