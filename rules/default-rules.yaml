version: 1
default_decision: ask
safety_level: high

allowlists:
  commands:
    # ── Always safe: read-only / output-only ──────────────────────
    - cd
    - ls
    - echo
    - pwd
    - whoami
    - date
    - cat
    - head
    - tail
    - wc
    - file
    - which
    - type
    - basename
    - dirname
    - realpath
    - readlink
    - stat
    - du
    - printf
    - md5sum
    - sha256sum
    - sha1sum
    - cksum
    - "true"
    - "false"
    - sleep
    - grep
    - rg
    - find
    - tree
    - xargs
    - fd
    - sort
    - uniq
    - tr
    - cut
    - diff
    - jq
    - yq
    - test
    - column
    - nl
    - tac
    - rev
    - paste
    - join
    - comm
    - cmp
    - strings
    - xxd
    - hexdump
    - od
    - base64
    - time
    # ── System info: read-only ───────────────────────────────────────
    - env
    - printenv
    - uname
    - hostname
    - id
    - groups
    - df
    - ps
    - pgrep
    - lsof
    - nproc
    - getconf
    - locale
    - uptime
    # ── Pagers and viewers ───────────────────────────────────────────
    - less
    - more
    - man
    - info
    # ── Modern CLI alternatives ──────────────────────────────────────
    - bat
    - exa
    - eza
    - delta
    - tokei
    - cloc
    - scc
    - hyperfine
    - ag
    - ack
    # ── Always safe: dev tools (no publish risk) ──────────────────
    - make
    - cmake
    - rustc
    - java
    - javac
    # npx - covered by npx-run rule (asks for confirmation)
    # ── Interpreters: safe invocations only ─────────────────────
    - "python --version"
    - "python -V"
    - "python3 --version"
    - "python3 -V"
    - "python -m json.tool"
    - "python3 -m json.tool"
    - "python -m py_compile"
    - "python3 -m py_compile"
    - "python -m compileall"
    - "python3 -m compileall"
    - "node --version"
    - "node -v"
    - "ruby --version"
    - "ruby -v"
    - "python -m pytest"
    - "python3 -m pytest"
    # ── uv: safe tool invocations ───────────────────────────────
    - "uv run pytest"
    - "uv run mypy"
    - "uv run ruff"
    - "uv run black"
    - "uv run isort"
    - "uv run flake8"
    - "uv run pylint"
    - "uv run pyright"
    - "uv run bandit"
    - "uv run coverage"
    - "uv run pre-commit"
    - "uv sync"
    - "uv lock"
    - "uv venv"
    - "uv pip"
    - "uv pip list"
    - "uv pip show"
    - "uv pip freeze"
    - "uv pip check"
    - "uv --version"
    - "uv --help"
    - "uv -V"
    # ── Django: safe manage.py commands ─────────────────────────────
    - "python manage.py check"
    - "python manage.py showmigrations"
    - "python manage.py diffsettings"
    - "python manage.py sqlmigrate"
    - "python manage.py sqlflush"
    - "python manage.py sqlsequencereset"
    - "python manage.py inspectdb"
    - "python manage.py test"
    - "python manage.py makemigrations"
    - "python manage.py runserver"
    - "python manage.py startapp"
    - "python manage.py startproject"
    - "python manage.py dumpdata"
    - "python manage.py makemessages"
    - "python manage.py compilemessages"
    # ── Django: python3 variants ────────────────────────────────────
    - "python3 manage.py check"
    - "python3 manage.py showmigrations"
    - "python3 manage.py diffsettings"
    - "python3 manage.py sqlmigrate"
    - "python3 manage.py sqlflush"
    - "python3 manage.py sqlsequencereset"
    - "python3 manage.py inspectdb"
    - "python3 manage.py test"
    - "python3 manage.py makemigrations"
    - "python3 manage.py runserver"
    - "python3 manage.py startapp"
    - "python3 manage.py startproject"
    - "python3 manage.py dumpdata"
    - "python3 manage.py makemessages"
    - "python3 manage.py compilemessages"
    # ── Django: uv run variants ─────────────────────────────────────
    - "uv run python manage.py check"
    - "uv run python manage.py showmigrations"
    - "uv run python manage.py diffsettings"
    - "uv run python manage.py sqlmigrate"
    - "uv run python manage.py sqlflush"
    - "uv run python manage.py sqlsequencereset"
    - "uv run python manage.py inspectdb"
    - "uv run python manage.py test"
    - "uv run python manage.py makemigrations"
    - "uv run python manage.py runserver"
    - "uv run python manage.py startapp"
    - "uv run python manage.py startproject"
    - "uv run python manage.py dumpdata"
    - "uv run python manage.py makemessages"
    - "uv run python manage.py compilemessages"
    - "uv run python3 manage.py check"
    - "uv run python3 manage.py showmigrations"
    - "uv run python3 manage.py diffsettings"
    - "uv run python3 manage.py sqlmigrate"
    - "uv run python3 manage.py sqlflush"
    - "uv run python3 manage.py sqlsequencereset"
    - "uv run python3 manage.py inspectdb"
    - "uv run python3 manage.py test"
    - "uv run python3 manage.py makemigrations"
    - "uv run python3 manage.py runserver"
    - "uv run python3 manage.py startapp"
    - "uv run python3 manage.py startproject"
    - "uv run python3 manage.py dumpdata"
    - "uv run python3 manage.py makemessages"
    - "uv run python3 manage.py compilemessages"
    # ── just: safe invocations ───────────────────────────────────
    - "just --list"
    - "just -l"
    - "just --version"
    - "just --help"
    - "just -h"
    - "just test"
    - "just build"
    - "just check"
    - "just fmt"
    - "just lint"
    # ── glp (GitLab Pipeline CLI): read-only invocations ──────────
    - "glp status"
    - "glp jobs"
    - "glp log"
    - "glp --version"
    - "glp --help"
    - "glp -h"
    # ── glab (GitLab CLI): read-only invocations ──────────────────
    # Note: mutating API calls (POST/PUT/DELETE/PATCH) caught by glab-api-mutating rule
    - "glab api"
    - "glab auth status"
    - "glab ci status"
    - "glab ci view"
    - "glab ci list"
    - "glab ci trace"
    - "glab ci get"
    - "glab repo list"
    - "glab repo view"
    - "glab group list"
    - "glab issue list"
    - "glab issue view"
    - "glab mr list"
    - "glab mr view"
    - "glab --version"
    - "glab --help"
    # ── gh (GitHub CLI): read-only invocations ───────────────────────
    # Note: mutating API calls (POST/PUT/DELETE/PATCH) caught by gh-api-mutating rule
    - "gh api"
    - "gh pr list"
    - "gh pr view"
    - "gh pr status"
    - "gh pr diff"
    - "gh pr checks"
    - "gh issue list"
    - "gh issue view"
    - "gh issue status"
    - "gh repo list"
    - "gh repo view"
    - "gh run list"
    - "gh run view"
    - "gh run watch"
    - "gh workflow list"
    - "gh workflow view"
    - "gh auth status"
    - "gh --version"
    - "gh --help"
    - "gh -h"
    # ── git-cliff: stdout-only invocations ────────────────────────
    - "git-cliff --unreleased"
    - "git-cliff --latest"
    - "git-cliff --current"
    # ── Always safe: filesystem ops (secrets caught by rules) ─────
    - mkdir
    - touch
    - ln
    - cp
    - mv
    - tee
    - tar
    - gzip
    - gunzip
    - zip
    - unzip
    # ── Always safe: text processing ──────────────────────────────
    - sed
    - awk
    - patch
    # ── Git: read operations ──────────────────────────────────────
    - "git status"
    - "git diff"
    - "git log"
    - "git show"
    - "git branch"
    - "git stash list"
    - "git remote"
    - "git tag"
    - "git rev-parse"
    - "git config"
    # ── Git: safe write operations ────────────────────────────────
    - "git add"
    - "git commit"
    - "git fetch"
    - "git pull"
    - "git push"
    - "git stash"
    - "git checkout"
    - "git switch"
    - "git restore"
    - "git merge"
    - "git rebase"
    - "git cherry-pick"
    - "git worktree"
    - "git clone"
    - "git init"
    # ── Git: read-only extras ─────────────────────────────────────
    - "git blame"
    - "git bisect"
    - "git describe"
    - "git shortlog"
    - "git reflog"
    - "git ls-files"
    - "git ls-tree"
    - "git cat-file"
    - "git grep"
    - "git archive"
    # ── Git: safe file operations ────────────────────────────────────
    - "git mv"
    - "git rm"
    - "git revert"
    # ── Git: stash operations ────────────────────────────────────────
    - "git stash pop"
    - "git stash apply"
    # ── Git: info/help commands ───────────────────────────────────
    - "git --version"
    - "git -v"
    - "git help"
    - "git -h"
    # ── Git: maintenance/inspection commands ──────────────────────
    - "git gc"
    - "git fsck"
    - "git verify-pack"
    # ── Git: history/ref commands ─────────────────────────────────
    - "git merge-base"
    - "git rev-list"
    - "git for-each-ref"
    - "git name-rev"
    # ── Cargo: safe invocations ───────────────────────────────────
    - "cargo build"
    - "cargo test"
    - "cargo check"
    - "cargo clippy"
    - "cargo fmt"
    - "cargo run"
    - "cargo bench"
    - "cargo doc"
    - "cargo clean"
    - "cargo update"
    - "cargo remove"
    - "cargo init"
    - "cargo new"
    - "cargo tree"
    - "cargo metadata"
    - "cargo vendor"
    - "cargo release"
    - "cargo deny"
    - "cargo audit"
    - "cargo outdated"
    - "cargo expand"
    # ── npm: safe invocations ─────────────────────────────────────
    # npm install/ci/exec - covered by rules (ask for confirmation)
    - "npm test"
    - "npm run"
    - "npm start"
    - "npm ls"
    - "npm outdated"
    - "npm audit"
    - "npm init"
    - "npm info"
    - "npm pack"
    # ── pip/pip3: safe invocations ────────────────────────────────
    # pip install - covered by rules (ask for confirmation)
    - "pip list"
    - "pip show"
    - "pip freeze"
    - "pip check"
    - "pip3 list"
    - "pip3 show"
    - "pip3 freeze"
    - "pip3 check"
    # ── gem: safe invocations ─────────────────────────────────────
    # gem install - covered by rules (ask for confirmation)
    - "gem list"
    - "gem info"
    - "gem search"
    - "gem --version"
    - "gem -v"
    # ── bundler: safe invocations ─────────────────────────────────
    # bundle install/add - covered by rules (ask for confirmation)
    - "bundle list"
    - "bundle show"
    - "bundle info"
    - "bundle check"
    - "bundle --version"
    - "bundle -v"
    - "bundler --version"
    # ── go: safe invocations ──────────────────────────────────────
    # go get/install - covered by rules (ask for confirmation)
    - "go build"
    - "go test"
    - "go run"
    - "go vet"
    - "go fmt"
    - "go mod"
    - "go generate"
    - "go doc"
    - "go clean"
    - "go env"
    - "go version"
    - "go work"
    # ── yarn: safe invocations ────────────────────────────────────
    # yarn add/install - covered by rules (ask for confirmation)
    - "yarn --version"
    - "yarn -v"
    - "yarn list"
    - "yarn info"
    - "yarn why"
    - "yarn run"
    - "yarn test"
    - "yarn build"
    - "yarn start"
    - "yarn lint"
    # ── pnpm: safe invocations ────────────────────────────────────
    # pnpm add/install - covered by rules (ask for confirmation)
    - "pnpm --version"
    - "pnpm -v"
    - "pnpm list"
    - "pnpm ls"
    - "pnpm why"
    - "pnpm run"
    - "pnpm test"
    - "pnpm build"
    - "pnpm start"
    - "pnpm audit"
    # ── bun: safe invocations ─────────────────────────────────────
    # bun add/install - covered by rules (ask for confirmation)
    - "bun --version"
    - "bun -v"
    - "bun run"
    - "bun test"
    - "bun build"
    # ── poetry: safe invocations ──────────────────────────────────
    # poetry add/install - covered by rules (ask for confirmation)
    - "poetry --version"
    - "poetry -V"
    - "poetry show"
    - "poetry list"
    - "poetry check"
    - "poetry lock"
    - "poetry run"
    - "poetry shell"
    - "poetry env"
    # ── pipx: safe invocations ────────────────────────────────────
    # pipx install - covered by rules (ask for confirmation)
    - "pipx --version"
    - "pipx list"
    - "pipx run"
    # ── pdm: safe invocations ─────────────────────────────────────
    # pdm add/install - covered by rules (ask for confirmation)
    - "pdm --version"
    - "pdm -V"
    - "pdm list"
    - "pdm show"
    - "pdm lock"
    - "pdm run"
    # ── rye: safe invocations ─────────────────────────────────────
    # rye add - covered by rules (ask for confirmation)
    - "rye --version"
    - "rye -V"
    - "rye list"
    - "rye show"
    - "rye lock"
    - "rye run"
    - "rye sync"
    # ── conda/mamba: safe invocations ─────────────────────────────
    # conda/mamba install - covered by rules (ask for confirmation)
    - "conda --version"
    - "conda -V"
    - "conda list"
    - "conda info"
    - "conda env"
    - "mamba --version"
    - "mamba list"
    - "mamba info"
    # ── composer: safe invocations ────────────────────────────────
    # composer require/install - covered by rules (ask for confirmation)
    - "composer --version"
    - "composer -V"
    - "composer show"
    - "composer list"
    - "composer info"
    - "composer check-platform-reqs"
    # ── brew: safe invocations ────────────────────────────────────
    # brew install - covered by rules (ask for confirmation)
    - "brew --version"
    - "brew list"
    - "brew info"
    - "brew search"
    - "brew doctor"
    - "brew outdated"
    # ── deno: safe invocations ────────────────────────────────────
    # deno install/add - covered by rules (ask for confirmation)
    - "deno --version"
    - "deno -V"
    - "deno run"
    - "deno test"
    - "deno lint"
    - "deno fmt"
    - "deno check"
    - "deno info"
    - "deno doc"
    # ── dotnet: safe invocations ──────────────────────────────────
    # dotnet add - covered by rules (ask for confirmation)
    - "dotnet --version"
    - "dotnet --info"
    - "dotnet build"
    - "dotnet run"
    - "dotnet test"
    - "dotnet clean"
    - "dotnet restore"
    - "dotnet list"
    # ── nuget: safe invocations ───────────────────────────────────
    # nuget install - covered by rules (ask for confirmation)
    - "nuget --version"
    - "nuget list"
    - "nuget sources"
    # ── mix (Elixir): safe invocations ────────────────────────────
    # mix deps.get - covered by rules (ask for confirmation)
    - "mix --version"
    - "mix help"
    - "mix compile"
    - "mix test"
    - "mix format"
    # ── pub (Dart): safe invocations ──────────────────────────────
    # pub get/add - covered by rules (ask for confirmation)
    - "dart pub --version"
    - "dart pub deps"
    - "dart pub outdated"
    - "flutter pub deps"
    - "flutter pub outdated"
    # ── cabal (Haskell): safe invocations ─────────────────────────
    # cabal install - covered by rules (ask for confirmation)
    - "cabal --version"
    - "cabal -V"
    - "cabal list"
    - "cabal info"
    - "cabal build"
    - "cabal test"
    - "cabal run"
    # ── stack (Haskell): safe invocations ─────────────────────────
    # stack install - covered by rules (ask for confirmation)
    - "stack --version"
    - "stack list-dependencies"
    - "stack build"
    - "stack test"
    - "stack run"

rules:
  # ============================================================
  # CRITICAL: Filesystem destruction
  # ============================================================
  - id: rm-recursive-root
    level: critical
    match:
      command: rm
      flags:
        any_of: ["-r", "-R", "--recursive", "-rf", "-fr", "-Rf", "-fR"]
      args:
        any_of: ["/", "/*"]
    decision: deny
    reason: "Recursive delete targeting root filesystem"

  - id: rm-recursive-system
    level: critical
    match:
      command: rm
      flags:
        any_of: ["-r", "-R", "--recursive", "-rf", "-fr", "-Rf", "-fR"]
      args:
        any_of: ["/etc", "/etc/*", "/usr", "/usr/*", "/var", "/var/*", "/bin",
                  "/bin/*", "/sbin", "/sbin/*", "/lib", "/lib/*", "/boot",
                  "/boot/*", "/sys", "/sys/*", "/proc", "/proc/*"]
    decision: deny
    reason: "Recursive delete targeting system directory"

  - id: rm-recursive-home
    level: critical
    match:
      command: rm
      flags:
        any_of: ["-r", "-R", "--recursive", "-rf", "-fr", "-Rf", "-fR"]
      args:
        any_of: ["~", "~/", "$HOME", "$HOME/"]
    decision: deny
    reason: "Recursive delete targeting home directory"

  - id: dd-disk-device
    level: critical
    match:
      command: dd
      args:
        any_of: ["of=/dev/sd*", "of=/dev/nvme*", "of=/dev/hd*",
                  "of=/dev/vd*", "of=/dev/xvd*", "of=/dev/disk*"]
    decision: deny
    reason: "dd writing directly to disk device"

  - id: mkfs-any
    level: critical
    match:
      command:
        any_of: [mkfs, "mkfs.ext4", "mkfs.xfs", "mkfs.btrfs", "mkfs.vfat", "mkfs.ntfs"]
    decision: deny
    reason: "Formatting a filesystem"

  - id: fork-bomb
    level: critical
    match:
      command: ":"
    decision: ask
    reason: "Potential fork bomb pattern"

  # ============================================================
  # CRITICAL: Shell injection / remote code execution
  # ============================================================
  - id: curl-pipe-shell
    level: critical
    match:
      pipeline:
        stages:
          - command:
              any_of: [curl, wget]
          - command:
              any_of: [sh, bash, zsh, dash, ksh, fish]
    decision: deny
    reason: "Remote code execution: piping download to shell"

  - id: wget-pipe-interpreter
    level: critical
    match:
      pipeline:
        stages:
          - command:
              any_of: [curl, wget]
          - command:
              any_of: [python, python3, ruby, perl, node]
    decision: deny
    reason: "Remote code execution: piping download to interpreter"

  # ============================================================
  # CRITICAL: Secrets exposure
  # ============================================================
  - id: cat-env-file
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "**/.env.production"]
    decision: deny
    reason: "Reading sensitive environment file"

  - id: cat-ssh-key
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: ["~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "id_rsa", "id_ed25519", "id_ecdsa"]
    decision: deny
    reason: "Reading SSH private key"

  - id: cat-aws-creds
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: ["~/.aws/credentials", "~/.aws/config"]
    decision: deny
    reason: "Reading AWS credentials"

  - id: cat-kube-config
    level: critical
    match:
      command:
        any_of: [cat, less, more, head, tail, bat]
      args:
        any_of: ["~/.kube/config"]
    decision: deny
    reason: "Reading Kubernetes config"

  - id: cp-secrets
    level: critical
    match:
      command: cp
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "id_rsa", "id_ed25519", "id_ecdsa",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: ask
    reason: "Copying sensitive file"

  - id: mv-secrets
    level: critical
    match:
      command: mv
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "id_rsa", "id_ed25519", "id_ecdsa",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: ask
    reason: "Moving sensitive file"

  - id: tee-secrets
    level: critical
    match:
      command: tee
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc", "**/.env", "**/.env.local",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: deny
    reason: "Writing to sensitive file via tee"

  - id: rm-secrets
    level: critical
    match:
      command: rm
      args:
        any_of: [".env", ".env.local", ".env.production", ".env.staging",
                  ".env.development", ".envrc",
                  "~/.ssh/id_*", "~/.ssh/id_rsa", "~/.ssh/id_ed25519",
                  "~/.ssh/id_ecdsa", "~/.ssh/authorized_keys",
                  "~/.aws/credentials", "~/.aws/config",
                  "~/.kube/config"]
    decision: ask
    reason: "Deleting sensitive file"

  # ============================================================
  # HIGH: VCS destructive operations
  # ============================================================
  - id: git-force-push-main
    level: high
    match:
      command: git
      flags:
        any_of: ["--force", "-f"]
      args:
        any_of: ["main", "master"]
    decision: deny
    reason: "Force pushing to main/master branch"

  - id: git-reset-hard
    level: high
    match:
      command: git
      args:
        any_of: ["--hard"]
    decision: ask
    reason: "git reset --hard discards uncommitted changes"

  - id: git-clean-force
    level: high
    match:
      command: git
      args:
        any_of: ["clean"]
      flags:
        any_of: ["-f", "--force", "-fd", "-fx", "-fxd"]
    decision: ask
    reason: "git clean -f permanently removes untracked files"

  - id: git-branch-delete-force
    level: high
    match:
      command: git
      args:
        any_of: ["branch"]
      flags:
        any_of: ["-D"]
    decision: ask
    reason: "Force deleting a git branch"

  - id: git-commit-amend
    level: high
    match:
      command: git
      args:
        any_of: ["commit"]
      flags:
        any_of: ["--amend"]
    decision: ask
    reason: "git commit --amend rewrites the previous commit"

  - id: git-remote-modify
    level: high
    match:
      command: git
      args:
        any_of: ["remote"]
      flags:
        any_of: ["add", "remove", "rm", "set-url", "rename"]
    decision: ask
    reason: "Modifying git remote configuration"

  - id: git-tag-delete
    level: high
    match:
      command: git
      args:
        any_of: ["tag"]
      flags:
        any_of: ["-d", "--delete"]
    decision: ask
    reason: "Deleting git tag"

  - id: git-push-delete
    level: high
    match:
      command: git
      args:
        any_of: ["push"]
      flags:
        any_of: ["--delete", "-d"]
    decision: ask
    reason: "Deleting remote branch or tag"

  - id: git-config-global
    level: high
    match:
      command: git
      args:
        any_of: ["config"]
      flags:
        any_of: ["--global", "--system"]
    decision: ask
    reason: "Modifying global/system git configuration"

  - id: git-stash-drop
    level: high
    match:
      command: git
      args:
        any_of: ["stash"]
      flags:
        any_of: ["drop", "clear"]
    decision: ask
    reason: "Dropping stashed changes (data loss)"

  - id: git-reflog-delete
    level: high
    match:
      command: git
      args:
        any_of: ["reflog"]
      flags:
        any_of: ["delete", "expire"]
    decision: ask
    reason: "Deleting reflog entries (history loss)"

  - id: git-gc-prune
    level: high
    match:
      command: git
      args:
        any_of: ["gc"]
      flags:
        starts_with: ["--prune"]
    decision: ask
    reason: "git gc with pruning can remove unreachable objects"

  - id: git-worktree-remove
    level: high
    match:
      command: git
      args:
        any_of: ["worktree"]
      flags:
        any_of: ["remove", "prune"]
    decision: ask
    reason: "Removing git worktree"

  - id: git-bisect-reset
    level: high
    match:
      command: git
      args:
        any_of: ["bisect"]
      flags:
        any_of: ["reset"]
    decision: ask
    reason: "Exiting bisect mode (changes HEAD)"

  - id: git-pull-force
    level: high
    match:
      command: git
      args:
        any_of: ["pull"]
      flags:
        any_of: ["--force", "-f"]
    decision: ask
    reason: "git pull --force can overwrite local changes"

  - id: git-rebase-abort
    level: high
    match:
      command: git
      args:
        any_of: ["rebase"]
      flags:
        any_of: ["--abort", "--skip"]
    decision: ask
    reason: "Aborting or skipping rebase (may lose changes)"

  # ============================================================
  # HIGH: CLI tool mutating operations
  # ============================================================
  - id: glab-api-mutating
    level: high
    match:
      command: glab
      args:
        any_of: ["POST", "PUT", "DELETE", "PATCH"]
    decision: ask
    reason: "GitLab API mutating operation (POST/PUT/DELETE/PATCH)"

  - id: gh-api-mutating
    level: high
    match:
      command: gh
      args:
        any_of: ["POST", "PUT", "DELETE", "PATCH"]
    decision: ask
    reason: "GitHub API mutating operation (POST/PUT/DELETE/PATCH)"

  # ============================================================
  # HIGH: Exfiltration
  # ============================================================
  - id: curl-upload-secrets
    level: high
    match:
      command: curl
      flags:
        any_of: ["-d", "--data", "-F", "--form", "--data-binary", "--data-urlencode", "-T", "--upload-file"]
    decision: ask
    reason: "curl with data upload flags"

  - id: scp-upload
    level: high
    match:
      command: scp
    decision: ask
    reason: "scp file transfer"

  - id: rsync-remote
    level: high
    match:
      command: rsync
    decision: ask
    reason: "rsync file transfer"

  - id: nc-netcat
    level: high
    match:
      command:
        any_of: [nc, netcat, ncat]
    decision: ask
    reason: "Netcat network connection"

  # ============================================================
  # HIGH: Secrets via environment
  # ============================================================
  - id: printenv
    level: high
    match:
      command:
        any_of: [printenv, env]
    decision: ask
    reason: "Environment dump may expose secrets"

  - id: source-env
    level: high
    match:
      command:
        any_of: [source, "."]
      args:
        any_of: [".env", ".env.*", "**/.env", "**/.env.*", ".envrc"]
    decision: deny
    reason: "Sourcing environment file"

  # ============================================================
  # HIGH: Network / process operations
  # ============================================================
  - id: kill-signal
    level: high
    match:
      command:
        any_of: [kill, killall, pkill]
      flags:
        any_of: ["-9", "-KILL", "-SIGKILL"]
    decision: ask
    reason: "Forceful process termination"

  - id: iptables-modify
    level: high
    match:
      command:
        any_of: [iptables, ip6tables, nft, ufw]
    decision: ask
    reason: "Firewall rule modification"

  # ============================================================
  # HIGH: System config modification
  # ============================================================
  - id: chmod-777
    level: high
    match:
      command: chmod
      args:
        any_of: ["777"]
    decision: ask
    reason: "Setting world-writable permissions"

  - id: edit-etc-hosts
    level: high
    match:
      command:
        any_of: [tee, ">>"]
      args:
        any_of: ["/etc/hosts"]
    decision: deny
    reason: "Modifying /etc/hosts"

  - id: edit-sudoers
    level: high
    match:
      command:
        any_of: [visudo, tee]
      args:
        any_of: ["/etc/sudoers", "/etc/sudoers.d/*"]
    decision: deny
    reason: "Modifying sudoers configuration"

  - id: crontab-modify
    level: high
    match:
      command: crontab
      flags:
        any_of: ["-e", "-r"]
    decision: ask
    reason: "Modifying system crontab"

  - id: systemctl-modify
    level: high
    match:
      command:
        any_of: [systemctl, launchctl]
      args:
        any_of: ["stop", "disable", "mask", "enable", "start", "restart"]
    decision: ask
    reason: "Modifying system service"

  - id: edit-shell-profile
    level: high
    match:
      command:
        any_of: [tee]
      args:
        any_of: ["~/.bashrc", "~/.zshrc", "~/.bash_profile", "~/.profile",
                  "~/.zprofile", "/etc/profile", "/etc/bash.bashrc"]
    decision: deny
    reason: "Modifying shell profile"

  # ============================================================
  # HIGH: Docker destructive
  # ============================================================
  - id: docker-volume-rm
    level: high
    match:
      command: docker
      args:
        any_of: ["volume"]
      flags:
        any_of: ["rm", "prune"]
    decision: ask
    reason: "Docker volume removal"

  - id: docker-system-prune
    level: high
    match:
      command: docker
      args:
        any_of: ["system"]
      flags:
        any_of: ["prune"]
    decision: ask
    reason: "Docker system prune"

  # ============================================================
  # HIGH: Disk / partition
  # ============================================================
  - id: fdisk
    level: high
    match:
      command:
        any_of: [fdisk, gdisk, parted, partprobe]
    decision: deny
    reason: "Disk partitioning tool"

  - id: mount-unmount
    level: high
    match:
      command:
        any_of: [mount, umount]
    decision: ask
    reason: "Filesystem mount/unmount"

  # ============================================================
  # HIGH: Destructive find/xargs patterns
  # ============================================================
  - id: find-delete
    level: high
    match:
      command: find
      flags:
        any_of: ["-delete"]
    decision: ask
    reason: "find -delete recursively removes matching files"

  - id: find-exec-rm
    level: high
    match:
      command: find
      args:
        any_of: ["-exec"]
      flags:
        any_of: ["rm"]
    decision: ask
    reason: "find -exec with rm can delete files"

  - id: xargs-rm
    level: high
    match:
      command: xargs
      args:
        any_of: ["rm"]
    decision: ask
    reason: "xargs executing rm on piped input"

  # ============================================================
  # HIGH: Filesystem destructive operations (allowlist bypass)
  # ============================================================
  - id: ln-force
    level: high
    match:
      command: ln
      flags:
        any_of: ["-f", "--force", "-sf", "-fs", "-fn", "-nf"]
    decision: ask
    reason: "ln -f can overwrite existing files"

  - id: cp-force
    level: high
    match:
      command: cp
      flags:
        any_of: ["-f", "--force", "-rf", "-fr"]
    decision: ask
    reason: "cp -f overwrites without prompting"

  - id: mv-force
    level: high
    match:
      command: mv
      flags:
        any_of: ["-f", "--force"]
    decision: ask
    reason: "mv -f overwrites without prompting"

  - id: tar-extract
    level: high
    match:
      command: tar
      flags:
        starts_with: ["-x", "--extract"]
    decision: ask
    reason: "tar extraction can overwrite files"

  - id: unzip-extract
    level: high
    match:
      command: unzip
      flags:
        none_of: ["-l", "-t", "-Z", "-v"]
    decision: ask
    reason: "unzip extraction can overwrite files"

  - id: sed-inplace
    level: high
    match:
      command: sed
      flags:
        starts_with: ["-i", "--in-place"]
    decision: ask
    reason: "sed -i modifies files in place"

  - id: patch-apply
    level: high
    match:
      command: patch
      flags:
        none_of: ["--dry-run", "-C", "--check"]
    decision: ask
    reason: "patch modifies files"

  - id: gzip-no-keep
    level: high
    match:
      command: gzip
      flags:
        none_of: ["-k", "--keep", "-c", "--stdout", "-t", "--test", "-l", "--list"]
    decision: ask
    reason: "gzip removes original file by default"

  - id: gunzip-no-keep
    level: high
    match:
      command: gunzip
      flags:
        none_of: ["-k", "--keep", "-c", "--stdout", "-t", "--test", "-l", "--list"]
    decision: ask
    reason: "gunzip removes original file by default"

  - id: tee-system-files
    level: high
    match:
      command: tee
      args:
        any_of: ["/etc/*", "/usr/*", "/var/*", "/bin/*", "/sbin/*", "/lib/*"]
    decision: ask
    reason: "Writing to system directory"

  # ============================================================
  # HIGH: Package installation (supply chain risk)
  # ============================================================
  # All package installation commands require confirmation.
  # Packages can contain arbitrary code that runs at install time.
  # Risk: typosquatting, malicious packages, supply chain attacks.
  #
  # Future: --allow-package-install flag could bypass this section.

  # ── Python package managers ──────────────────────────────────
  - id: pip-install
    level: high
    match:
      command:
        any_of: [pip, pip3]
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Python packages"

  - id: pip-download
    level: high
    match:
      command:
        any_of: [pip, pip3]
      args:
        any_of: ["download"]
    decision: ask
    reason: "Downloading Python packages"

  - id: python-m-pip-install
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["-m"]
      flags:
        any_of: ["pip"]
    decision: ask
    reason: "Installing Python packages via python -m pip"

  - id: uv-pip-install
    level: high
    match:
      command: uv
      args:
        any_of: ["pip"]
      flags:
        any_of: ["install"]
    decision: ask
    reason: "Installing Python packages via uv"

  - id: uv-add
    level: high
    match:
      command: uv
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Python dependency via uv"

  - id: poetry-add
    level: high
    match:
      command: poetry
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Python dependency via Poetry"

  - id: poetry-install
    level: high
    match:
      command: poetry
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Python dependencies via Poetry"

  - id: pipx-install
    level: high
    match:
      command: pipx
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Python application via pipx"

  - id: pdm-add
    level: high
    match:
      command: pdm
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Python dependency via PDM"

  - id: pdm-install
    level: high
    match:
      command: pdm
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Python dependencies via PDM"

  - id: rye-add
    level: high
    match:
      command: rye
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Python dependency via Rye"

  - id: conda-install
    level: high
    match:
      command:
        any_of: [conda, mamba]
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing packages via Conda/Mamba"

  # ── JavaScript/Node package managers ─────────────────────────
  - id: npm-install
    level: high
    match:
      command: npm
      args:
        any_of: ["install", "i", "ci"]
    decision: ask
    reason: "Installing npm packages"

  - id: npm-audit-fix
    level: high
    match:
      command: npm
      args:
        any_of: ["audit"]
      flags:
        any_of: ["fix"]
    decision: ask
    reason: "npm audit fix modifies package dependencies"

  - id: npm-exec
    level: high
    match:
      command: npm
      args:
        any_of: ["exec"]
    decision: ask
    reason: "npm exec runs arbitrary package code"

  - id: npx-run
    level: high
    match:
      command: npx
    decision: ask
    reason: "npx can execute arbitrary npm packages"

  - id: yarn-add
    level: high
    match:
      command: yarn
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding npm package via Yarn"

  - id: yarn-install
    level: high
    match:
      command: yarn
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing npm packages via Yarn"

  - id: pnpm-add
    level: high
    match:
      command: pnpm
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding npm package via pnpm"

  - id: pnpm-install
    level: high
    match:
      command: pnpm
      args:
        any_of: ["install", "i"]
    decision: ask
    reason: "Installing npm packages via pnpm"

  - id: bun-add
    level: high
    match:
      command: bun
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding npm package via Bun"

  - id: bun-install
    level: high
    match:
      command: bun
      args:
        any_of: ["install", "i"]
    decision: ask
    reason: "Installing npm packages via Bun"

  # ── Ruby package managers ────────────────────────────────────
  - id: gem-install
    level: high
    match:
      command: gem
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Ruby gems"

  - id: bundle-install
    level: high
    match:
      command:
        any_of: [bundle, bundler]
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Ruby gems via Bundler"

  - id: bundle-add
    level: high
    match:
      command:
        any_of: [bundle, bundler]
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Ruby gem via Bundler"

  # ── Rust package managers ────────────────────────────────────
  - id: cargo-add
    level: high
    match:
      command: cargo
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Rust crate dependency"

  - id: cargo-install
    level: high
    match:
      command: cargo
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Rust binary"

  # ── Go package managers ──────────────────────────────────────
  - id: go-get
    level: high
    match:
      command: go
      args:
        any_of: ["get"]
    decision: ask
    reason: "Fetching Go module"

  - id: go-install
    level: high
    match:
      command: go
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Go binary"

  # ── PHP package managers ─────────────────────────────────────
  - id: composer-require
    level: high
    match:
      command: composer
      args:
        any_of: ["require"]
    decision: ask
    reason: "Adding PHP package via Composer"

  - id: composer-install
    level: high
    match:
      command: composer
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing PHP packages via Composer"

  # ── System package managers ──────────────────────────────────
  - id: brew-install
    level: high
    match:
      command: brew
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing package via Homebrew"

  - id: apt-install
    level: high
    match:
      command:
        any_of: [apt, apt-get]
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing system package via apt"

  - id: dnf-install
    level: high
    match:
      command:
        any_of: [dnf, yum]
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing system package via dnf/yum"

  - id: pacman-install
    level: high
    match:
      command: pacman
      flags:
        any_of: ["-S", "--sync"]
    decision: ask
    reason: "Installing system package via pacman"

  - id: apk-add
    level: high
    match:
      command: apk
      args:
        any_of: ["add"]
    decision: ask
    reason: "Installing Alpine package"

  - id: snap-install
    level: high
    match:
      command: snap
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Snap package"

  - id: flatpak-install
    level: high
    match:
      command: flatpak
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Flatpak application"

  - id: nix-env-install
    level: high
    match:
      command: nix-env
      flags:
        any_of: ["-i", "--install"]
    decision: ask
    reason: "Installing package via Nix"

  # ── Deno package managers ────────────────────────────────────
  - id: deno-install
    level: high
    match:
      command: deno
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Deno package"

  - id: deno-add
    level: high
    match:
      command: deno
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding Deno dependency"

  # ── .NET package managers ────────────────────────────────────
  - id: dotnet-add-package
    level: high
    match:
      command: dotnet
      args:
        any_of: ["add"]
    decision: ask
    reason: "Adding .NET package"

  - id: nuget-install
    level: high
    match:
      command: nuget
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing NuGet package"

  # ── Elixir package managers ──────────────────────────────────
  - id: mix-deps-get
    level: high
    match:
      command: mix
      args:
        any_of: ["deps.get"]
    decision: ask
    reason: "Fetching Elixir dependencies"

  - id: mix-archive-install
    level: high
    match:
      command: mix
      args:
        any_of: ["archive.install", "escript.install"]
    decision: ask
    reason: "Installing Elixir archive/escript"

  # ── Dart/Flutter package managers ────────────────────────────
  - id: dart-pub-get
    level: high
    match:
      command: dart
      args:
        any_of: ["pub"]
      flags:
        any_of: ["get", "add"]
    decision: ask
    reason: "Installing Dart packages"

  - id: flutter-pub-get
    level: high
    match:
      command: flutter
      args:
        any_of: ["pub"]
      flags:
        any_of: ["get", "add"]
    decision: ask
    reason: "Installing Flutter packages"

  - id: pub-get
    level: high
    match:
      command: pub
      args:
        any_of: ["get", "add"]
    decision: ask
    reason: "Installing Dart packages via pub"

  # ── Haskell package managers ─────────────────────────────────
  - id: cabal-install
    level: high
    match:
      command: cabal
      args:
        any_of: ["install", "v2-install"]
    decision: ask
    reason: "Installing Haskell package via Cabal"

  - id: stack-install
    level: high
    match:
      command: stack
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Haskell package via Stack"

  # ── Lua package managers ─────────────────────────────────────
  - id: luarocks-install
    level: high
    match:
      command: luarocks
      args:
        any_of: ["install"]
    decision: ask
    reason: "Installing Lua rock"

  # ── sudo/privilege escalation wrappers ───────────────────────
  - id: sudo-package-install
    level: high
    match:
      command: sudo
      args:
        any_of: ["pip", "pip3", "npm", "gem", "apt", "apt-get", "dnf", "yum",
                 "pacman", "apk", "brew", "snap", "flatpak"]
    decision: ask
    reason: "Package installation with sudo"

  - id: doas-package-install
    level: high
    match:
      command: doas
      args:
        any_of: ["pip", "pip3", "npm", "gem", "apt", "apt-get", "dnf", "yum",
                 "pacman", "apk", "brew", "snap", "flatpak"]
    decision: ask
    reason: "Package installation with doas"

  # ============================================================
  # STRICT: Cautionary
  # ============================================================
  - id: git-force-push-any
    level: strict
    match:
      command: git
      flags:
        any_of: ["--force", "-f"]
      args:
        any_of: ["push"]
    decision: ask
    reason: "Force pushing (any branch)"

  - id: git-checkout-dot
    level: strict
    match:
      command: git
      args:
        any_of: ["checkout", "restore"]
      flags:
        any_of: [".", "--"]
    decision: ask
    reason: "Discarding all local changes"

  - id: sudo-rm
    level: strict
    match:
      command: sudo
      args:
        any_of: ["rm"]
    decision: ask
    reason: "Running rm with elevated privileges"

  - id: crontab-remove
    level: strict
    match:
      command: crontab
      flags:
        any_of: ["-r"]
    decision: deny
    reason: "Removing all cron jobs"

  # ============================================================
  # HIGH: Django destructive operations
  # ============================================================
  - id: django-migrate
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["migrate"]
    decision: ask
    reason: "Django migrate modifies database schema"

  - id: django-flush
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["flush"]
    decision: ask
    reason: "Django flush deletes all data from database"

  - id: django-loaddata
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["loaddata"]
    decision: ask
    reason: "Django loaddata modifies database content"

  - id: django-createsuperuser
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["createsuperuser"]
    decision: ask
    reason: "Django createsuperuser creates admin user"

  - id: django-changepassword
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["changepassword"]
    decision: ask
    reason: "Django changepassword modifies user credentials"

  - id: django-clearsessions
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["clearsessions"]
    decision: ask
    reason: "Django clearsessions deletes session data"

  - id: django-dbshell
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["dbshell"]
    decision: ask
    reason: "Django dbshell provides direct database access"

  - id: django-shell
    level: high
    match:
      command:
        any_of: [python, python3]
      args:
        any_of: ["manage.py", "*/manage.py"]
      flags:
        any_of: ["shell", "shell_plus"]
    decision: ask
    reason: "Django shell provides arbitrary code execution"

  # ── Django: uv run variants ───────────────────────────────────
  - id: uv-django-migrate
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["migrate"]
    decision: ask
    reason: "Django migrate modifies database schema"

  - id: uv-django-flush
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["flush"]
    decision: ask
    reason: "Django flush deletes all data from database"

  - id: uv-django-loaddata
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["loaddata"]
    decision: ask
    reason: "Django loaddata modifies database content"

  - id: uv-django-createsuperuser
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["createsuperuser"]
    decision: ask
    reason: "Django createsuperuser creates admin user"

  - id: uv-django-changepassword
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["changepassword"]
    decision: ask
    reason: "Django changepassword modifies user credentials"

  - id: uv-django-clearsessions
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["clearsessions"]
    decision: ask
    reason: "Django clearsessions deletes session data"

  - id: uv-django-dbshell
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["dbshell"]
    decision: ask
    reason: "Django dbshell provides direct database access"

  - id: uv-django-shell
    level: high
    match:
      command: uv
      args:
        any_of: ["run"]
      flags:
        any_of: ["shell", "shell_plus"]
    decision: ask
    reason: "Django shell provides arbitrary code execution"
